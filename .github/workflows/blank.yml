name: "âš¡ Deploy: ${{ github.event.client_payload.repository_name }} â†’ ${{ github.event.client_payload.environment }} | SHA: ${{ github.event.client_payload.commit_sha }}"

# This workflow is triggered by an API call from another repository.
on:
  repository_dispatch:
    types: [deploy]

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: "${{ github.event.client_payload.repository_name }} â†’ ${{ github.event.client_payload.environment }} | ${{ github.event.client_payload.app_type }} | Trigger Run #${{ github.event.client_payload.trigger_run_number }}"
    
    steps:
      # Enhanced deployment info with links back to trigger
      - name: "ğŸ“Š Deployment Information"
        run: |
          echo "::notice title=ğŸš€ Deployment Started::Repo: ${{ github.event.client_payload.repository_name }}, Environment: ${{ github.event.client_payload.environment }}, Commit: ${{ github.event.client_payload.commit_sha }}"
          echo "=================================="
          echo "ğŸ“‹ DEPLOYMENT DETAILS"
          echo "=================================="
          echo "ğŸ·ï¸  Repository: ${{ github.event.client_payload.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.event.client_payload.branch }}"
          echo "ğŸ¯ Environment: ${{ github.event.client_payload.environment }}"
          echo "ğŸ“¦ Application Type: ${{ github.event.client_payload.app_type }}"
          echo "ğŸ” Commit SHA: ${{ github.event.client_payload.commit_sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.event.client_payload.actor }}"
          echo "ğŸ”— Trigger Workflow: ${{ github.event.client_payload.trigger_workflow_url }}"
          echo "ğŸ“Š Trigger Run Number: #${{ github.event.client_payload.trigger_run_number }}"
          echo "â° Deploy Started: $(date)"
          echo "=================================="

      # Step 1: Checkout the code from the private repository.
      - name: "ğŸ“¥ Checkout Private Repository"
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.repository }}
          ref: ${{ github.event.client_payload.branch }}
          token: ${{ github.event.client_payload.repo_token }}
          path: my-private-app-code

      - name: "âœ… Repository Checkout Complete"
        run: |
          echo "Repository checked out successfully!"
          echo "Files in repository:"
          ls -la my-private-app-code/
          if [ -f "my-private-app-code/deploy.sh" ]; then
            echo "âœ… deploy.sh found"
          else
            echo "âŒ deploy.sh not found!"
            exit 1
          fi

      # Step 2: Set up the correct runtime environment based on the application type.
      - name: "â˜• Set up Java 17"
        if: github.event.client_payload.app_type == 'java'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: "âœ… Java Setup Complete"
        if: github.event.client_payload.app_type == 'java'
        run: |
          echo "Java version:"
          java -version
          echo "Maven version:"
          mvn -version || echo "Maven not available"
          
      - name: "ğŸŸ¢ Set up Node.js 21"
        if: github.event.client_payload.app_type == 'angular'
        uses: actions/setup-node@v4
        with:
          node-version: '21'

      - name: "âœ… Node.js Setup Complete"
        if: github.event.client_payload.app_type == 'angular'
        run: |
          echo "Node.js version:"
          node --version
          echo "npm version:"
          npm --version
      
      # Step 3: Setup SSH key from the payload.
      - name: "ğŸ” Setup SSH"
        run: |
          mkdir -p ~/.ssh
          echo "${{ github.event.client_payload.ssh_private_key }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Add known hosts to prevent SSH host key verification issues
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          echo "âœ… SSH key configured successfully"

      # Step 4: Make deployment script executable and run it
      - name: "ğŸ”§ Prepare Deploy Script"
        run: |
          chmod +x my-private-app-code/deploy.sh
          echo "âœ… Deploy script made executable"
          
      - name: "ğŸ” Verify Script Permissions"
        run: |
          echo "Deploy script permissions:"
          ls -la my-private-app-code/deploy.sh
          echo "Script exists and is executable: âœ…"

      - name: "ğŸš€ Execute Deployment"
        run: |
          echo "::group::ğŸš€ Starting deployment for ${{ github.event.client_payload.app_type }} application to ${{ github.event.client_payload.environment }}..."
          echo "=================================="
          echo "DEPLOYMENT EXECUTION"
          echo "=================================="
          
          # Run the deployment script with all parameters
          my-private-app-code/deploy.sh \
            --app_type "${{ github.event.client_payload.app_type }}" \
            --environment "${{ github.event.client_payload.environment }}" \
            --commit "${{ github.event.client_payload.commit_sha }}" \
            --repo "${{ github.event.client_payload.repository }}" \
            --branch "${{ github.event.client_payload.branch }}" \
            --actor "${{ github.event.client_payload.actor }}" \
            --trigger_run "${{ github.event.client_payload.trigger_run_number }}"
          
          deploy_exit_code=$?
          echo "::endgroup::"
          
          if [ $deploy_exit_code -eq 0 ]; then
            echo "::notice title=âœ… Deployment Successful::${{ github.event.client_payload.repository_name }} deployed to ${{ github.event.client_payload.environment }} successfully!"
            echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          else
            echo "::error title=âŒ Deployment Failed::Deployment script exited with code $deploy_exit_code"
            echo "ğŸ’¥ DEPLOYMENT FAILED!"
            exit $deploy_exit_code
          fi

      - name: "ğŸ“ˆ Deployment Summary"
        if: always()
        run: |
          echo "=================================="
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "=================================="
          echo "ğŸ·ï¸  Repository: ${{ github.event.client_payload.repository_name }}"
          echo "ğŸŒ¿ Branch: ${{ github.event.client_payload.branch }}"
          echo "ğŸ¯ Environment: ${{ github.event.client_payload.environment }}"
          echo "ğŸ“¦ App Type: ${{ github.event.client_payload.app_type }}"
          echo "ğŸ” Commit: ${{ github.event.client_payload.commit_sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.event.client_payload.actor }}"
          echo "â° Completed: $(date)"
          echo "ğŸ”— Trigger: ${{ github.event.client_payload.trigger_workflow_url }}"
          echo "=================================="
